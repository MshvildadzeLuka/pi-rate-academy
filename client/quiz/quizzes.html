<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizzes | Pi-Rate Academy</title>
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../header/header.css">
    <link rel="stylesheet" href="quizzes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>
</head>
<body>
    <div id="header-placeholder"></div>

    <div id="quiz-wrapper">
        <main class="quizzes-container">
            <div class="quizzes-main-header">
                <h1>Quizzes</h1>
                <div class="header-actions" id="teacher-admin-controls" style="display: none;">
                    <div class="form-group">
                        <select id="group-select" aria-label="Choose a Group"></select>
                    </div>
                    <button id="create-quiz-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Quiz
                    </button>
                </div>
            </div>

            <nav class="tabs-nav" id="tabs-nav">
                <button class="tab-btn active" data-action="change-tab" data-tab="active">Active</button>
                <button class="tab-btn" data-action="change-tab" data-tab="upcoming">Upcoming</button>
                <button class="tab-btn" data-action="change-tab" data-tab="completed">Completed</button>
                <button class="tab-btn" data-action="change-tab" data-tab="past-due">Past Due</button>
                <button class="tab-btn" data-action="change-tab" data-tab="requests" id="requests-tab" style="display: none;">Requests</button>
            </nav>

            <div class="content-area">
                <div id="quiz-list-view" class="view active">
                    </div>
                <div id="quiz-detail-view" class="view" style="display: none;">
                    </div>
            </div>
        </main>

        <div id="modal-backdrop" class="modal-backdrop" style="display: none;"></div>
    </div>
    <template id="template-create-edit-quiz-modal">
        <div class="modal" id="create-quiz-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-header">
                <h2 id="modal-title">Create Quiz</h2>
                <button class="close-modal-btn" data-action="close-modal" aria-label="Close modal">&times;</button>
            </div>
            <form id="quiz-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="quiz-title">Title</label>
                        <input type="text" id="quiz-title" name="title" required>
                    </div>
                     <div class="form-group">
                        <label for="quiz-description">Description</label>
                        <textarea id="quiz-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quiz-group">Group</label>
                            <select id="quiz-group" name="groupId" required></select>
                        </div>
                        <div class="form-group">
                            <label for="quiz-time-limit">Time Limit (minutes)</label>
                            <input type="number" id="quiz-time-limit" name="timeLimit" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quiz-start-time">Start Time</label>
                            <input type="datetime-local" id="quiz-start-time" name="startTime" required>
                        </div>
                        <div class="form-group">
                            <label for="quiz-end-time">End Time</label>
                            <input type="datetime-local" id="quiz-end-time" name="endTime" required>
                        </div>
                    </div>

                    <div class="questions-section">
                        <div class="section-header">
                            <h3>Questions</h3>
                            <div class="section-actions">
                                <button type="button" class="btn btn-secondary" id="add-from-quiz-bank-btn" data-action="add-from-quiz-bank">
                                    <i class="fas fa-book"></i> Add from Quiz Bank
                                </button>
                                <button type="button" class="btn btn-primary" id="add-question-btn" data-action="add-question">
                                    <i class="fas fa-plus"></i> Add Question
                                </button>
                            </div>
                        </div>
                        <div class="questions-container" id="questions-container">
                            </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Quiz</button>
                </div>
            </form>
        </div>
    </template>

    <template id="template-quiz-bank-modal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="quiz-bank-title">
            <div class="modal-header">
                <h2 id="quiz-bank-title">Select a Quiz Template</h2>
                <button class="close-modal-btn" data-action="close-modal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="list-container quiz-bank-list">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
            </div>
        </div>
    </template>

    <template id="template-question-item">
        <div class="question-item">
            <div class="question-header">
                <span class="question-number">Question #1</span>
                <div class="question-actions">
                    <button type="button" class="btn btn-secondary btn-icon" data-action="preview-question" aria-label="Preview question">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-icon move-up-btn" data-action="move-question-up" aria-label="Move question up"><i class="fas fa-arrow-up"></i></button>
                    <button type="button" class="btn btn-icon move-down-btn" data-action="move-question-down" aria-label="Move question down"><i class="fas fa-arrow-down"></i></button>
                    <button type="button" class="btn btn-icon delete-question-btn" data-action="delete-question" aria-label="Delete question"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Question Text (LaTeX supported)</label>
                <textarea class="question-text" placeholder="e.g., What is the value of $$ \int_0^1 x^2 dx $$?" rows="3"></textarea>
                <div class="latex-preview"></div>
            </div>

            <div class="form-group">
                <label>Question Image (Optional)</label>
                <div class="question-image-uploader">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Drag & drop or click to browse</p>
                    <input type="file" class="question-image-input" accept="image/*" style="display: none;">
                </div>
                <div class="question-image-preview" style="display: none;">
                    <img src="" alt="Question image preview" data-public-id="">
                    <button type="button" class="remove-image-btn" data-action="remove-question-image" aria-label="Remove image"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="form-group options-container-wrapper">
                <label>Answer Options</label>
                <div class="options-container"></div>
                <button type="button" class="btn btn-secondary add-option-btn" data-action="add-option"><i class="fas fa-plus"></i> Add Option</button>
            </div>

            <div class="form-group">
                <label>Solution / Explanation (LaTeX supported)</label>
                <textarea class="question-solution" placeholder="Explain the correct answer..." rows="3"></textarea>
                <div class="latex-preview"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="question-points" min="0" value="1">
                </div>
            </div>
        </div>
    </template>

    <template id="template-option-item">
        <div class="option-item">
            <div class="option-controls">
                <input type="radio" name="correct-option" class="correct-option-radio" aria-label="Mark as correct">
                <span class="option-letter">A</span>
            </div>
            <input type="text" class="option-text" placeholder="Option text (LaTeX supported)">
            <button type="button" class="btn btn-icon delete-option-btn" data-action="delete-option" aria-label="Delete option">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </template>

    <template id="template-quiz-instructions-modal">
        <div class="modal quiz-instructions-modal" role="dialog" aria-modal="true" aria-labelledby="instructions-title">
            <div class="modal-header">
                <h2 id="instructions-title">Quiz Instructions: <span class="quiz-instructions-title"></span></h2>
                <button class="close-modal-btn" data-action="close-modal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="quiz-instructions-content">
                    <h3>Before You Begin</h3>
                    <div id="password-field-container" style="display: none;">
                        <div class="form-group">
                            <label for="quiz-password">Quiz Password</label>
                            <input type="password" id="quiz-password" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="quiz-specific-instructions">
                        <h4>Quiz Instructions</h4>
                        <div id="quiz-instructions-text" class="instructions-text"></div>
                    </div>
                    
                    <p>Please read the following general instructions carefully:</p>
                    <ul class="instructions-list">
                        <li><i class="fas fa-exclamation-circle"></i> Do not navigate away from the quiz page or it will automatically submit.</li>
                        <li><i class="fas fa-exclamation-circle"></i> Do not refresh the page during the quiz.</li>
                        <li><i class="fas fa-exclamation-circle"></i> The quiz will be automatically submitted when you finish.</li>
                        <li><i class="fas fa-exclamation-circle"></i> Use of external resources is strictly prohibited.</li>
                    </ul>
                    <div class="agreement-section">
                        <label class="agreement-checkbox">
                            <input type="checkbox" id="quiz-agreement">
                            <span class="checkmark"></span>
                            I have read and understand all instructions
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="start-quiz-after-instructions" disabled>
                    Start Quiz
                </button>
            </div>
        </div>
    </template>

    <template id="template-quiz-taking-modal">
        <div class="modal quiz-taking-container">
            <div class="quiz-header">
                <div class="quiz-title-taking"></div>
                <div class="quiz-timer">
                    <i class="fas fa-clock"></i>
                    <span id="quiz-countdown">00:00</span>
                </div>
            </div>
            <div class="quiz-progress">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="progress-text">Question <span id="current-question-number">1</span> of <span id="total-questions">0</span></div>
            </div>
            <div class="question-container">
                <div class="error-message" style="display: none;"></div>
                <div class="question-text-taking"></div>
                <div class="question-image-container" style="display: none;">
                    <img src="" alt="Question image">
                </div>
                <div class="options-container-taking">
                    </div>
            </div>
            <div class="quiz-navigation">
                <button class="btn btn-secondary prev-question-btn" data-action="prev-question" disabled>Previous</button>
                <button class="btn btn-warning" data-action="finish-quiz">End Quiz Immediately</button>
                <button class="btn btn-primary next-question-btn" data-action="next-question">Next Question</button>
                <button class="btn btn-danger finish-quiz-btn" data-action="finish-quiz" style="display: none;">Finish Quiz</button>
            </div>
        </div>
    </template>

    <template id="template-quiz-results">
        <div class="quiz-results-container">
            <div class="results-header">
                <h2>Quiz Results: <span class="quiz-title-results"></span></h2>
                <div class="score-display">
                    <div class="score-circle" style="--percentage: 0%;">
                        <span class="score-value">0</span>
                        <span class="score-total">/ 0</span>
                    </div>
                    <div class="score-text">
                        <p>You scored <strong class="score-percentage">0%</strong></p>
                    </div>
                </div>
            </div>
            <h3 class="review-title">Question Review</h3>
            <div class="questions-review">
                </div>
            <div class="results-actions">
                <button class="btn btn-primary" data-action="back-to-list">Back to Quizzes</button>
                <button class="btn btn-secondary" data-action="request-retake" style="display: none;">Request Retake</button>
            </div>
        </div>
    </template>

    <template id="template-question-review">
        <div class="question-review-item">
            <div class="question-header-review">
                <span class="question-number-review">Question #</span>
                <span class="question-points-review">0/0 Points</span>
            </div>
            <div class="question-text-review"></div>
            <div class="question-image-review" style="display: none;">
                <img src="" alt="Question image">
            </div>
            <div class="options-review">
                </div>
            <div class="solution-container">
                <h4>Solution</h4>
                <div class="solution-text"></div>
            </div>
        </div>
    </template>

    <template id="template-teacher-quiz-detail-view">
        <div class="detail-panel">
            <div class="detail-panel-header">
                <button class="btn back-btn" data-action="back-to-list" aria-label="Back to quizzes list">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h2 class="quiz-title-detail"></h2>
                <div class="teacher-quiz-actions">
                    <button class="btn btn-secondary edit-quiz-btn" data-action="edit-quiz">
                        <i class="fas fa-edit"></i> Edit Quiz
                    </button>
                    <button class="btn btn-danger delete-quiz-btn" data-action="delete-quiz">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            <div class="quiz-info">
                <div class="info-item">
                    <label>Group:</label>
                    <span class="group-name"></span>
                </div>
                <div class="info-item">
                    <label>Start Time:</label>
                    <span class="start-time"></span>
                </div>
                <div class="info-item">
                    <label>End Time:</label>
                    <span class="end-time"></span>
                </div>
                <div class="info-item">
                    <label>Status:</label>
                    <span class="status-badge"></span>
                </div>
            </div>
            <div class="quiz-stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-students">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-attempts">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="average-score">0%</div>
                    <div class="stat-label">Average Score</div>
                </div>
            </div>
            <div class="student-attempts-container">
                <h3>Student Attempts</h3>
                <div class="student-list">
                    </div>
            </div>
        </div>
    </template>

    <template id="template-student-attempt-item">
        <div class="student-attempt-item">
            <div class="student-info">
                <span class="student-name"></span>
                <span class="student-email"></span>
            </div>
            <div class="attempt-info">
                <span class="attempt-status"></span>
                <span class="attempt-score"></span>
            </div>
            <div class="attempt-actions">
                <button class="btn btn-secondary view-attempt-btn" data-action="view-student-attempt">
                    <i class="fas fa-eye"></i> View
                </button>
            </div>
        </div>
    </template>

    <div id="notification-container" aria-live="assertive" aria-atomic="true"></div>

    <script src="../header/header.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="quizzes.js"></script>
</body>
</html>
